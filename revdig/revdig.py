#automation script to sweep a CIDR range with dig
#returns hostnames resolved from IPs via PTR records
#syntax: revdig.py <cidr range> <optional-outfile>
#example: revdig.py 208.67.222.0/24 opendns.txt

import subprocess,sys
from netaddr import IPNetwork
import dns.resolver
import dns.reversename

def reverse(ip):
	try:
		resolver = dns.resolver.Resolver()
		addr = dns.reversename.from_address(ip)
		answers = resolver.query(addr, "PTR")
		return ip + " : " + str(answers[0]) + "\n"
	except dns.resolver.NXDOMAIN:
		return []

cidr = sys.argv[1]
ips = []

try:
	outname = sys.argv[2]
	fd = open(outname, "w", 0)
except:
	fd = None

for ip in IPNetwork(cidr):
	ips.append(str(ip))
for ip in ips:
	result = reverse(ip)
	if len(result) > 0:
		sys.stdout.write(result)	
		if fd != None:
			fd.write(result)

try:
	fd.close()
except:
	pass
